#!/bin/sh

# Input should look like this for an end record:
# $1: '-s' (the subject argument keyword)
# $2: The subject itself
# $3: The To: email address.

JOB_ID=$(echo "$2" | sed 's/.*Job_id=\([0-9]*\).*/\1/')

ROUTING_KEY="xt_$3"

PAYLOAD=$(jq -n --arg jobid "$JOB_ID" \
             '{"pattern":"jobs/complete", "data": {"id": $jobid}}')

BODY=$(jq -n --arg payload "$PAYLOAD" --arg routing_key "$ROUTING_KEY" \
             '{properties: {}, routing_key: $routing_key, payload: $payload, payload_encoding: "string"}')

echo "curl -i -X POST -L -u slurm:redacted -d ""$BODY"" http://queue.csquare.app/api/exchanges/%2F/amq.default/publish" >> /var/log/fakemail.log

curl -i -X POST -L -u 'slurm:f_4UyDHC7!w$Cc2KSHFv' -d "$BODY" https://queue.csquare.app/api/exchanges/%2F/amq.default/publish
