###### Cluster
### Basics
ClusterName=mandelbrot

NodeName=cn-n2s2cpu-[1-50] Feature=cloud State=CLOUD CPUs=2 RealMemory=7000 TRESWeights="CPU=1.0,Mem=0.25G,GRES/gpu=0.0" Weight=7000
NodeName=cn-n2s4cpu-[1-50] Feature=cloud State=CLOUD CPUs=4 RealMemory=15000 TRESWeights="CPU=1.0,Mem=0.25G,GRES/gpu=0.0" Weight=15000
NodeName=cn-n2s8cpu-[1-50] Feature=cloud State=CLOUD CPUs=8 RealMemory=30000 TRESWeights="CPU=1.0,Mem=0.25G,GRES/gpu=0.0" Weight=30000
NodeName=cn-n2s16cpu-[1-50] Feature=cloud State=CLOUD CPUs=16 RealMemory=63000 TRESWeights="CPU=1.0,Mem=0.25G,GRES/gpu=0.0" Weight=63000
NodeName=cn-n2s32cpu-[1-50] Feature=cloud State=CLOUD CPUs=32 RealMemory=126000 TRESWeights="CPU=1.0,Mem=0.25G,GRES/gpu=0.0" Weight=126000
NodeName=cn-n2s48cpu-[1-50] Feature=cloud State=CLOUD CPUs=48 RealMemory=190000 TRESWeights="CPU=1.0,Mem=0.25G,GRES/gpu=0.0" Weight=190000
NodeName=cn-n2s64cpu-[1-50] Feature=cloud State=CLOUD CPUs=64 RealMemory=254000 TRESWeights="CPU=1.0,Mem=0.25G,GRES/gpu=0.0" Weight=254000
NodeName=cn-n2s80cpu-[1-50] Feature=cloud State=CLOUD CPUs=80 RealMemory=318000 TRESWeights="CPU=1.0,Mem=0.25G,GRES/gpu=0.0" Weight=318000
NodeName=cn-n1s4cpu1gpu-[1-7] Feature=cloud,cuda State=CLOUD CPUs=4 RealMemory=14000 Gres=gpu:1 TRESWeights="CPU=1.0,Mem=0.25G,GRES/gpu=10.0" Weight=140000
NodeName=cn-n1s8cpu1gpu-[1-7] Feature=cloud,cuda State=CLOUD CPUs=8 RealMemory=29000 Gres=gpu:1 TRESWeights="CPU=1.0,Mem=0.25G,GRES/gpu=10.0" Weight=290000
NodeName=cn-n1s4cpu2gpu-[1-7] Feature=cloud,cuda State=CLOUD CPUs=4 RealMemory=14000 Gres=gpu:2 TRESWeights="CPU=1.0,Mem=0.25G,GRES/gpu=10.0" Weight=140000
NodeName=cn-n1s8cpu2gpu-[1-7] Feature=cloud,cuda State=CLOUD CPUs=8 RealMemory=29000 Gres=gpu:2 TRESWeights="CPU=1.0,Mem=0.25G,GRES/gpu=10.0" Weight=290000
NodeName=cn-n1s16cpu2gpu-[1-7] Feature=cloud,cuda State=CLOUD CPUs=16 RealMemory=58000 Gres=gpu:2 TRESWeights="CPU=1.0,Mem=0.25G,GRES/gpu=10.0" Weight=580000
NodeName=cn-a2h12cpu1gpu-[1-7] Feature=cloud,cuda State=CLOUD CPUs=12 RealMemory=83000 Gres=gpu:1 TRESWeights="CPU=1.0,Mem=0.25G,GRES/gpu=20.0" Weight=830000
NodeName=cn-a2h24cpu2gpu-[1-7] Feature=cloud,cuda State=CLOUD CPUs=24 RealMemory=165000 Gres=gpu:2 TRESWeights="CPU=1.0,Mem=0.25G,GRES/gpu=20.0" Weight=1650000

NodeName=slurm-headnode


PartitionName=main Nodes=cn-n2s2cpu-[1-50],cn-n2s4cpu-[1-50],cn-n2s8cpu-[1-50],cn-n2s16cpu-[1-50],cn-n2s32cpu-[1-50],cn-n1s4cpu1gpu-[1-7],cn-n1s8cpu1gpu-[1-7],cn-n1s4cpu2gpu-[1-7],cn-n1s8cpu2gpu-[1-7],cn-n1s16cpu2gpu-[1-7] Default=YES MaxTime=2:00:00 State=UP OverSubscribe=NO
PartitionName=n2s2cpu Nodes=cn-n2s2cpu-[1-50] Default=NO MaxTime=2:00:00 State=UP OverSubscribe=NO
PartitionName=n2s4cpu Nodes=cn-n2s4cpu-[1-50] Default=NO MaxTime=2:00:00 State=UP OverSubscribe=NO
PartitionName=n2s8cpu Nodes=cn-n2s8cpu-[1-50] Default=NO MaxTime=2:00:00 State=UP OverSubscribe=NO
PartitionName=n2s16cpu Nodes=cn-n2s16cpu-[1-50] Default=NO MaxTime=2:00:00 State=UP OverSubscribe=NO
PartitionName=n2s32cpu Nodes=cn-n2s32cpu-[1-50] Default=NO MaxTime=2:00:00 State=UP OverSubscribe=NO
#PartitionName=n2s48cpu Nodes=cn-n2s48cpu-[1-50] Default=NO MaxTime=2:00:00 State=UP OverSubscribe=NO
#PartitionName=n2s64cpu Nodes=cn-n2s64cpu-[1-50] Default=NO MaxTime=2:00:00 State=UP OverSubscribe=NO
#PartitionName=n2s80cpu Nodes=cn-n2s80cpu-[1-50] Default=NO MaxTime=2:00:00 State=UP OverSubscribe=NO
PartitionName=n1s4cpu1gpu Nodes=cn-n1s4cpu1gpu-[1-7] Default=NO MaxTime=2:00:00 State=UP OverSubscribe=NO
PartitionName=n1s8cpu1gpu Nodes=cn-n1s8cpu1gpu-[1-7] Default=NO MaxTime=2:00:00 State=UP OverSubscribe=NO
PartitionName=n1s4cpu2gpu Nodes=cn-n1s4cpu2gpu-[1-7] Default=NO MaxTime=2:00:00 State=UP OverSubscribe=NO
PartitionName=n1s8cpu2gpu Nodes=cn-n1s8cpu2gpu-[1-7] Default=NO MaxTime=2:00:00 State=UP OverSubscribe=NO
PartitionName=n1s16cpu2gpu Nodes=cn-n1s16cpu2gpu-[1-7] Default=NO MaxTime=2:00:00 State=UP OverSubscribe=NO
#PartitionName=a2h12cpu1gpu Nodes=cn-a2h12cpu1gpu-[1-7] Default=NO MaxTime=2:00:00 State=UP OverSubscribe=NO
#PartitionName=a2h24cpu2gpu Nodes=cn-a2h24cpu2gpu-[1-7] Default=NO MaxTime=2:00:00 State=UP OverSubscribe=NO


###### Software components
#-- Slurm controller
SlurmctldHost=slurm-controller(10.10.64.10)
SlurmctldParameters=enable_configless,idle_on_node_suspend,cloud_dns
SlurmctldDebug=error
DebugFlags=GRES
SlurmUser=slurm
StateSaveLocation=/var/spool/slurmctl
SlurmctldLogFile=/var/log/slurm/slurmctld.log
# StateSaveLocation default is /var/spool which is dirty as other programs
# also write data there
SlurmctldPidFile=/var/run/slurmctld.pid
MailProg=/usr/bin/fakemail

#-- Slurmd
SlurmdDebug=debug5
CommunicationParameters=NoAddrCache
#,NoCtldInAddrAny,NoInAddrAny
SlurmdLogFile=/var/log/slurm/slurmd.log
Prolog=/etc/slurm/prolog.d/*
Epilog=/etc/slurm/epilog.d/*
SrunPortRange=60001-63000

#-- Authentication
AuthAltTypes=auth/jwt
AuthAltParameters=jwt_key=/var/spool/slurmctl/jwt_hs256.key

#-- Accounting
AccountingStorageTRES=gres/gpu
AccountingStorageType=accounting_storage/slurmdbd
AccountingStorageHost=slurmdbd.csquare.gcloud
AccountingStorageUser=slurmdb
AccountingStoreFlags=job_comment,job_env,job_script

#-- System configuration
ReturnToService=2
# NoAddrCache is required in the cloud because the IPs change
# if compute nodes come & go, and the controller doesn't follow unless this is set
SuspendProgram=/slurm_powersave/suspend.sh
ResumeProgram=/slurm_powersave/resume.sh
SuspendExcNodes=slurm-headnode
SuspendTime=180
ResumeTimeout=600
MessageTimeout=90

#-- Scheduling
SchedulerType=sched/builtin
SelectType=select/cons_tres
SelectTypeParameters=CR_CPU_Memory
PriorityType=priority/basic
# PriorityType=priority/multifactor
# PriorityWeightAge=0
# PriorityWeightFairshare=0
# PriorityWeightTRES=CPU=1000,Mem=1,GRES/gpu=1000000
# PriorityWeightJobSize=0
# PriorityWeightPartition=0
# PriorityWeightQOS=0 # don't use the qos factor

#-- Cluster settings
PropagateResourceLimitsExcept=MEMLOCK
ProctrackType=proctrack/cgroup
TaskPlugin=task/cgroup
#TaskPlugin=task/cgroup,task/affinity
SwitchType=switch/none
MpiDefault=pmix_v2
GresTypes=gpu

#-- Default ressources allocation
DefCpuPerGPU=8
DefMemPerCPU=3000
#MaxMemPerCPU=1700
