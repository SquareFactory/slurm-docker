version: '3.9'

services:
  # nginx:
  #   image: nginx:alpine
  #   restart: always
  #   network_mode: host
  #   depends_on:
  #     - "slurm-0"
  #   volumes:
  #     - ./logs/nginx:/var/log/nginx
  #     - ./nginx/nginx.conf:/etc/nginx/nginx.conf
  #     - ./nginx/certs/slurmrest.csquare.gcloud.crt:/etc/ssl/certs/slurmrest.csquare.gcloud.crt
  #     - ./nginx/certs/slurmrest.csquare.gcloud.key:/etc/ssl/certs/slurmrest.csquare.gcloud.key

  slurm-0:
    image: slurm
    restart: always
    pull_policy: never
    network_mode: host
    build:
      context: ./slurm
      dockerfile: Dockerfile
      target: slurm-slurmd
    hostname: slurm-0
    container_name: slurm-0
    volumes:
      - /etc/ssl/certs/ldap-certificate.pem:/etc/ssl/certs/ldap-certificate.pem:ro
      - ./secrets/sssd.conf:/etc/sssd/sssd.conf:ro
      - ./secrets/munge.key:/secrets/munge.key:ro
      - ./secrets/jwt_hs256.key:/secrets/jwt_hs256.key:ro
      - ./conf/slurm.conf:/etc/slurm/slurm.conf:ro
      - ./conf/sshd_config:/etc/ssh/sshd_config:ro
      - ./secrets/hostkeys/ssh_host_rsa_key:/etc/ssh/ssh_host_rsa_key
      - ./secrets/hostkeys/ssh_host_ecdsa_key:/etc/ssh/ssh_host_ecdsa_key
      - ./secrets/hostkeys/ssh_host_ed25519_key:/etc/ssh/ssh_host_ed25519_key
      - ./logs/slurm:/var/log/slurm
      - /opt/cvmfs:/opt/cvmfs
      - /opt/gentoo:/opt/gentoo
    # cpus: 0.50
    # mem_reservation: 512M
    # mem_limit: 512M
    # memswap_limit: 512M

volumes:
  ldap-users:
    driver_opts:
      type: "nfs"
      o: "nfsvers=3,addr=10.10.2.11,nolock,soft,rw"
      device: ":/mnt/pool1/ldap-users"
  jobs-logs:
    driver_opts:
      type: "nfs"
      o: "nfsvers=3,addr=10.10.2.11,nolock,soft,rw"
      device: ":/mnt/pool1/compute-nodes/jobs-logs"
  images:
    driver_opts:
      type: "nfs"
      o: "nfsvers=3,addr=10.10.2.11,nolock,soft,rw"
      device: ":/mnt/pool1/compute-nodes/images"
  experiments:
    driver_opts:
      type: "nfs"
      o: "nfsvers=3,addr=10.10.2.11,nolock,soft,rw"
      device: ":/mnt/pool1/compute-nodes/experiments"
